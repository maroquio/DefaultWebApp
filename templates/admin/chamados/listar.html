{% extends "base_privada.html" %}
{% from 'macros/badges.html' import badge_status_chamado, badge_prioridade, badge_mensagens_nao_lidas %}
{% from 'macros/empty_states.html' import empty_state %}

{% block titulo %}Gerenciar Chamados{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-headset"></i> Gerenciar Chamados</h2>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                {% if chamados %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Título</th>
                                <th scope="col">Usuário</th>
                                <th scope="col">Status</th>
                                <th scope="col">Prioridade</th>
                                <th scope="col">Data Abertura</th>
                                <th scope="col" class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for chamado in chamados %}
                            <tr>
                                <td><strong>#{{ chamado.id }}</strong></td>
                                <td>
                                    <div class="text-truncate" style="max-width: 300px;" title="{{ chamado.titulo }}">
                                        {{ chamado.titulo }}
                                    </div>
                                    <div class="mt-1">{{ badge_mensagens_nao_lidas(chamado.mensagens_nao_lidas) }}</div>
                                </td>
                                <td>
                                    <div>{{ chamado.usuario_nome }}</div>
                                    <small class="text-muted">{{ chamado.usuario_email }}</small>
                                </td>
                                <td>
                                    {{ badge_status_chamado(chamado.status) }}
                                </td>
                                <td>
                                    {{ badge_prioridade(chamado.prioridade) }}
                                </td>
                                <td>{{ chamado.data_abertura|formatar_data_hora if chamado.data_abertura else '-' }}</td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="/admin/chamados/{{ chamado.id }}/responder"
                                            class="btn btn-outline-primary"
                                            title="Responder"
                                            aria-label="Responder chamado #{{ chamado.id }}">
                                            <i class="bi bi-reply"></i>
                                        </a>
                                        {% if chamado.status.value == 'Fechado' %}
                                        <button type="button" class="btn btn-outline-success"
                                            title="Reabrir"
                                            aria-label="Reabrir chamado #{{ chamado.id }}"
                                            onclick="reabrirChamado({{ chamado.id }}, '{{ chamado.titulo|replace("'", "\\'") }}')">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn btn-outline-secondary"
                                            title="Fechar"
                                            aria-label="Fechar chamado #{{ chamado.id }}"
                                            onclick="fecharChamado({{ chamado.id }}, '{{ chamado.titulo|replace("'", "\\'") }}')">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <small class="text-muted">
                        Total: {{ chamados|length }} chamado(s)
                        {% set pendentes = chamados|selectattr('status.value', 'in', ['Aberto', 'Em Análise'])|list %}
                        {% if pendentes %}
                        | Pendentes: <strong class="text-danger">{{ pendentes|length }}</strong>
                        {% endif %}
                        {% set resolvidos = chamados|selectattr('status.value', 'equalto', 'Resolvido')|list %}
                        {% if resolvidos %}
                        | Resolvidos: <strong class="text-success">{{ resolvidos|length }}</strong>
                        {% endif %}
                    </small>
                </div>
                {% else %}
                {{ empty_state(
                    'Nenhum chamado cadastrado',
                    'Ainda não há chamados no sistema. Aguarde os usuários abrirem chamados de suporte.',
                    icon='headset',
                    variant='info'
                ) }}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% include 'components/modal_confirmacao.html' %}
{% endblock %}

{% block scripts %}
<script>
    function fecharChamado(chamadoId, chamadoTitulo) {
        const detalhes = `
        <div class="card bg-light border-secondary">
            <div class="card-body">
                <h6 class="card-title mb-2">
                    <i class="bi bi-ticket-detailed"></i> Chamado #${chamadoId}:
                </h6>
                <p class="mb-0"><strong>${chamadoTitulo}</strong></p>
                <hr>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> O chamado será fechado sem adicionar uma nova mensagem.
                    <br>O usuário será notificado sobre o fechamento.
                </small>
            </div>
        </div>
    `;

        abrirModalConfirmacao({
            url: `/admin/chamados/${chamadoId}/fechar`,
            tipo: 'warning',
            titulo: 'Confirmar Fechamento',
            icone: 'bi-lock-fill',
            mensagem: 'Tem certeza que deseja fechar este chamado?',
            detalhes: detalhes,
            btnTexto: 'Fechar Chamado',
            btnIcone: 'bi-lock-fill',
            avisoTexto: 'Esta ação pode ser revertida reabrindo o chamado.'
        });
    }

    function reabrirChamado(chamadoId, chamadoTitulo) {
        const detalhes = `
        <div class="card bg-light border-success">
            <div class="card-body">
                <h6 class="card-title mb-2">
                    <i class="bi bi-ticket-detailed"></i> Chamado #${chamadoId}:
                </h6>
                <p class="mb-0"><strong>${chamadoTitulo}</strong></p>
                <hr>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> O chamado será reaberto com status "Em Análise".
                    <br>O usuário poderá adicionar novas mensagens ao chamado.
                </small>
            </div>
        </div>
    `;

        abrirModalConfirmacao({
            url: `/admin/chamados/${chamadoId}/reabrir`,
            tipo: 'success',
            titulo: 'Confirmar Reabertura',
            icone: 'bi-arrow-counterclockwise',
            mensagem: 'Tem certeza que deseja reabrir este chamado?',
            detalhes: detalhes,
            btnTexto: 'Reabrir Chamado',
            btnIcone: 'bi-arrow-counterclockwise',
            avisoTexto: 'O chamado voltará ao status "Em Análise".'
        });
    }
</script>
{% endblock %}